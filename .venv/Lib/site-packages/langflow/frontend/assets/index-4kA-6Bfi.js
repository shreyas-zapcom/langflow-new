import{av as L,aw as R,ax as T,az as w,j as n,au as re,c as A,aP as G,u as $,i as U,aQ as le,aR as de,aB as ce,aC as ie,aS as ue,r as C,ay as J,g as P,aT as V,I as O,aU as pe}from"./index-BMduUo-e.js";import{H as fe}from"./index-CkPPVlXA.js";import{I as me}from"./input-0yNO_Rdy.js";const ge=u=>{const{mutate:p}=L();return p(["usePatchFolders"],async r=>{const o={name:r.data.name,description:r.data.description,flows_list:r.data.flows??[],components_list:r.data.components??[]};return(await R.patch(`${T("FOLDERS")}/${r.folderId}`,o)).data},u)},he=u=>{const{mutate:p}=L();return p(["usePostFolders"],async r=>{const o={name:r.data.name,description:r.data.description,flows_list:r.data.flows??[],components_list:r.data.components??[]};return(await R.post(`${T("FOLDERS")}/`,o)).data},u)},Fe=u=>{const{mutate:p}=L();return p(["usePostUploadFolders"],async r=>{const o=await R.post(`${T("FOLDERS")}/upload/`,r.formData);return await w.getState().getFoldersApi(!0),o.data},u)},we=({items:u,pathname:p})=>n.jsx("div",{className:"flex gap-2 overflow-auto lg:h-[70vh] lg:flex-col",children:u.map(s=>n.jsx(re,{to:s.href,children:n.jsxs("div",{"data-testid":`sidebar-nav-${s.title}`,className:A(G({variant:"ghost"}),p===s.href?"border border-border bg-muted hover:bg-muted":"border border-transparent hover:border-border hover:bg-transparent","flex w-full shrink-0 justify-start gap-4"),children:[s.icon,n.jsx("span",{className:"block max-w-full truncate opacity-100",children:s.title})]},s.title)}))}),xe=we,De=u=>{const{mutate:p}=L();return p(["useGetFolders"],async r=>(await R.get(`${T("FOLDERS")}/download/${r.folderId}`)).data,u)},ve=(u,p)=>{const s=w(a=>a.setFolderDragging),f=w(a=>a.setFolderIdDragging),r=$(a=>a.setErrorData),o=w(a=>a.refreshFolders),D=U(a=>a.flows),m=a=>{p&&p(a)},E=async a=>{if(a.dataTransfer.types.some(c=>c==="Files")&&a.dataTransfer.files&&a.dataTransfer.files.length>0){const c=a.dataTransfer.files[0];c.type==="application/json"?_(c):r({title:ce,list:[ie]})}},h=(a,c)=>{a.preventDefault(),a.dataTransfer.types.some(F=>F==="Files")&&s(!0),f(c)},y=(a,c)=>{a.dataTransfer.types.some(F=>F==="Files")&&s(!0),f(c),a.preventDefault()},N=a=>{a.preventDefault(),a.target===a.currentTarget&&(s(!1),f(""))},S=(a,c)=>{var F,v;if((F=a==null?void 0:a.dataTransfer)!=null&&F.getData("flow")){const j=JSON.parse((v=a==null?void 0:a.dataTransfer)==null?void 0:v.getData("flow"));if(j){b(j.id,c);return}}a.preventDefault(),E(a)},b=(a,c)=>{const F=D.find(I=>I.id===a);if(!F)throw new Error("Flow not found");const v={...F,folder_id:c},j=le(v,D);v.name=j,s(!1),f(""),de(v).then(()=>{o(),m(c)})},_=a=>{const c=new FormData;c.append("file",a),s(!1),f(""),ue(c,u).then(()=>{o(),m(u)})};return{dragOver:h,dragEnter:y,dragLeave:N,onDrop:S}},be=({pathname:u,handleChangeFolder:p,handleDeleteFolder:s})=>{var z;const f=C.useRef(null),r=w(e=>e.setFolders),o=w(e=>e.folders),[D,m]=C.useState({}),E=U(e=>e.takeSnapshot),[h,y]=C.useState(o.map(e=>({name:e.name,edit:!1}))),N=u.split("/"),S=u.split("/").length<4,b=w(e=>e.myCollectionId),_=w(e=>e.folderIdDragging),a=w(e=>e.refreshFolders),c=e=>S&&e===b?!0:N.includes(e),F=J(),v=((z=F==null?void 0:F.state)==null?void 0:z.folderId)??b,j=w(e=>e.getFolderById),I=$(e=>e.setErrorData),H=$(e=>e.setSuccessData);w(e=>e.getFoldersApi);const K=()=>{j(v)},{dragOver:M,dragEnter:W,dragLeave:q,onDrop:Q}=ve(v,K),{mutate:X}=Fe(),Y=()=>{const e=document.createElement("input");e.type="file",e.accept=".json",e.click(),e.onchange=g=>{if(g.target.files[0].type==="application/json"){const l=g.target.files[0],t=new FormData;t.append("file",l),l.text().then(async i=>{var x;const d=JSON.parse(i);(x=d.data)!=null&&x.nodes?(await U.getState().addFlow(!0,d),j(v)):X({formData:t},{onSuccess:()=>{j(v),H({title:"Uploaded successfully"})},onError:k=>{console.log(k),I({title:"Error on upload",list:[k.response.data]})}})})}}},{mutate:Z}=De(),ee=e=>{Z({folderId:e},{onSuccess:g=>{const l=o.find(d=>d.id===g.folderId);g.folder_name=(l==null?void 0:l.name)||"folder",g.folder_description=(l==null?void 0:l.description)||"";const t=`data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(g))}`,i=document.createElement("a");i.href=t,i.download=`${g.folder_name}.json`,i.click()},onError:()=>{I({title:"An error occurred while downloading folder."})}})},{mutate:ae}=he(),{mutate:te}=ge();function ne(){ae({data:{name:"New Folder",parent_id:null,description:""}},{onSuccess:()=>{a()}})}function oe(e,g){const{target:{value:l}}=e;m(t=>({...t,[g]:l}))}C.useEffect(()=>{o.map(e=>({name:e.name,edit:!1}))},[o]);const se=async e=>{var l,t;const g=h.map(i=>i.name===e.name?{name:e.name,edit:!1}:{name:i.name,edit:!1});if(y(g),D[e.name].trim()!==""){m(d=>({...d,[e.name]:D[e.name]}));const i={...e,name:D[e.name],flows:((l=e.flows)==null?void 0:l.length)>0?e.flows:[],components:((t=e.components)==null?void 0:t.length)>0?e.components:[]};te({data:i,folderId:e.id},{onSuccess:d=>{const x=o.findIndex(B=>B.id===d.id),k=[...o];k[x]=d,r(k),m({}),y(o.map(B=>({name:B.name,edit:!1})))}})}else m(i=>({...i,[e.name]:e.name}))};return n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"flex shrink-0 items-center justify-between gap-2",children:[n.jsx("div",{className:"flex-1 self-start text-lg font-semibold",children:"Folders"}),n.jsx(P,{variant:"primary",size:"icon",className:"px-2",onClick:ne,"data-testid":"add-folder-button",children:n.jsx(V,{name:"FolderPlus",className:"w-4"})}),n.jsx(P,{variant:"primary",size:"icon",className:"px-2",onClick:Y,"data-testid":"upload-folder-button",children:n.jsx(V,{name:"Upload",className:"w-4"})})]}),n.jsx("div",{className:"flex gap-2 overflow-auto lg:h-[70vh] lg:flex-col",children:n.jsx(n.Fragment,{children:o.map((e,g)=>{const l=h==null?void 0:h.filter(t=>t.name===e.name)[0];return n.jsx("div",{onDragOver:t=>M(t,e.id),onDragEnter:t=>W(t,e.id),onDragLeave:q,onDrop:t=>Q(t,e.id),"data-testid":`sidebar-nav-${e.name}`,className:A(G({variant:"ghost"}),c(e.id)?"border border-border bg-muted hover:bg-muted":"border hover:bg-transparent lg:border-transparent lg:hover:border-border","group flex w-full shrink-0 cursor-pointer gap-2 opacity-100 lg:min-w-full",_===e.id?"bg-border":""),onClick:()=>p(e.id),children:n.jsxs("div",{onDoubleClick:t=>{var i;if(e.name!=="My Projects"){if(D[e.name]||m({[e.name]:e.name}),(i=h.find(d=>d.name===e.name))!=null&&i.name){const d=h.map(x=>x.name===e.name?{name:e.name,edit:!0}:{name:x.name,edit:!1});y(d),E(),t.stopPropagation(),t.preventDefault();return}y(d=>[...d,{name:e.name,edit:!0}]),m(d=>({...d,[e.name]:e.name})),E(),t.stopPropagation(),t.preventDefault()}},className:"flex w-full items-center gap-2",children:[n.jsx(O,{name:"folder",className:"mr-2 w-4 flex-shrink-0 justify-start stroke-[1.5] opacity-100"}),l!=null&&l.edit?n.jsx("div",{children:n.jsx(me,{className:"w-36",onChange:t=>{oe(t,e.name)},ref:f,onKeyDown:t=>{var i;if(t.key==="Escape"){const d=h.map(x=>x.name===e.name?{name:e.name,edit:!1}:{name:x.name,edit:!1});y(d),m({}),y(o.map(x=>({name:x.name,edit:!1})))}t.key==="Enter"&&((i=f.current)==null||i.blur()),pe(t,t.key,"")},autoFocus:!0,onBlur:async()=>{var t;((t=f.current)==null?void 0:t.value)!==e.name?se(e):l.edit=!1},value:D[e.name],id:`input-folder-${e.name}`,"data-testid":"input-folder"})}):n.jsx("span",{className:"block w-full truncate opacity-100",children:e.name}),g>0&&n.jsx(P,{"data-testid":"btn-delete-folder",className:"hidden p-0 hover:bg-white group-hover:block hover:dark:bg-[#0c101a00]",onClick:t=>{s(e),t.stopPropagation(),t.preventDefault()},variant:"ghost",size:"icon",children:n.jsx(O,{name:"trash",className:"w-4 stroke-[1.5] p-0"})}),n.jsx(P,{className:"hidden p-0 hover:bg-white group-hover:block hover:dark:bg-[#0c101a00]",onClick:t=>{ee(e.id),t.stopPropagation(),t.preventDefault()},unstyled:!0,children:n.jsx(O,{name:"Download",className:"w-4 stroke-[1.5] text-white"})})]})},e.id)})})})]})},ye=be;function Se({className:u,items:p,handleChangeFolder:s,handleEditFolder:f,handleDeleteFolder:r,...o}){const m=J().pathname,E=w(b=>b.isLoadingFolders),h=w(b=>b.folders),N=["folder","components","flows","all"].some(b=>m.includes(b)),S=p.length>0?n.jsx(xe,{items:p,pathname:m}):!E&&(h==null?void 0:h.length)>0&&N?n.jsx(ye,{pathname:m,handleChangeFolder:s,handleDeleteFolder:r}):null;return n.jsx("nav",{className:A(u),...o,children:n.jsx(fe,{children:S})})}export{Se as S};
